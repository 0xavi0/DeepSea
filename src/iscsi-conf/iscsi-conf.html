<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../iscsi-target/iscsi-target.html">
<link rel="import" href="../salt-api/wf-salt-api.html">

<dom-module id="iscsi-conf">
    <template>
        <style>
         :host {
             display: block;

             padding: 10px 20px;
         }

         .add-target-button {
             width: 50px;
             height: 50px;
         }

         .generate-config-file-button {
             background: #85aa94
         }
        </style>

        <h1>iSCSI Targets</h1>
        <paper-icon-button title="Add a new iSCSI target" class="add-target-button" icon="add" on-tap="newTarget">Add Target</paper-icon-button>

        <paper-button id="get-iscsi-data-button" raised on-click="_getIscsiData"
                      disabled$="{{getIscsiDataButtonDisabled}}">Query iSCSI Data
            <paper-spinner active$="{{getIscsiDataButtonDisabled}}" hidden$="{{!getIscsiDataButtonDisabled}}">
            </paper-spinner>
        </paper-button>
        <br>
        <paper-button raised on-click="generateConfigFile" id="generate-config-file-button"
                      class="generate-config-file-button" icon="add" hidden$="{{generateConfigFileButtonHidden}}">
            Generate LRBD Config
        </paper-button>

        <!-- Query interfaces and images from salt-api backend. -->
        <wf-salt-api
            id="populateiscsi"
            cmd=""
            arg=""
            target=""
            func="ui.populate_iscsi"
            canned="1">
	</wf-salt-api>
    </template>

    <script>
     Polymer({
         is: 'iscsi-conf',
         properties: {
             targetList: {
                 type: Array,
                 value: [],
             },

             generateConfigFileButtonHidden: {
                 type: Boolean,
                 value: true,
             },

	     availableImgList: {
		 type: Array,
		 value: function() {
		     return [];
		 },
		 notify: true
	     },

	     availableIntfList: {
		 type: Array,
		 value: function() {
		     return [];
		 },
		 notify: true
	     },

             getIscsiDataButtonDisabled: {
                 type: Boolean,
                 value: true
             }
         },

	 observers: [
	     "_iscsiImagesChanged(availableImgList.splices)",
	     "_iscsiInterfacesChanged(availableIntfList.splices)"
	 ],

         listeners: {
	     "wf-salt-api-response": "handleIscsi200",
	     "wf-salt-api-error": "handleIscsiErr"
	 },

         ready: function() {
             this.addEventListener('removeTarget', function(e) {
                 console.debug("Removing target: " + e.target.name);
                 /* Remove from view. */
                 this.removeChild(e.target);

                 /* Remove from targetList array. */
                 var index = this.targetList.indexOf(e.target);
                 if (index > -1) {
                     this.targetList.splice(index, 1);
                 }
                 this.displayGenerateConfigFileButton();
             });

             /* On load, try to populate iSCSI data. */
             this._getIscsiData();
         },

         /* Takes an array of { "img": "", "pool": "" } and returns an
          * array of iscsi-conf-target:{Image}.
          */
         _parseImgData: function(imgDataArr) {
             var imageArr = [];
             for (var i = 0; i < imgDataArr.length; i++) {
                 var img = imgDataArr[i].img;
                 var pool = imgDataArr[i].pool;
                 imageArr.push(new Image(img, pool));
             }
             return imageArr;
         },

         /* Takes an array of { "node": "", "addr": "" } and returns an
          * array of iscsi-conf-target:{Interface}.
          */
         _parseIntfData: function(intfDataArr) {
             var interfaceArr = [];
             for (var i = 0; i < intfDataArr.length; i++) {
                 var node = intfDataArr[i].node;
                 var addr = intfDataArr[i].addr;
                 interfaceArr.push(new Interface(node, addr));
             }
             return interfaceArr;
         },

         /* Invokes the populateiscsi wf-salt-api ajax call. */
         _getIscsiData: function() {
             console.log(this.is + ":" + arguments.callee.name + ": updating iSCSI data");

             /* Disable load button and enable spinner. */
             this.getIscsiDataButtonDisabled = true;

             /* Try to get some data. */
             this.$.populateiscsi.runPost();
         },

         handleIscsi200: function(e) {
             console.log(this.is + ":" + arguments.callee.name + ": caught " + e.type);
             console.log(this.is + ":" + arguments.callee.name + ": populating image and interface lists");

             var resp = e.detail.response.return[0];
             this.getIscsiDataButtonDisabled = false;

             if (resp.interfaces === undefined || resp.images === undefined) {
                 alert("Invalid iSCSI data returned from server.");
             } else {
                 this.set("availableImgList", this._parseImgData(resp.images));
                 this.set("availableIntfList", this._parseIntfData(resp.interfaces));
             }
         },

         handleIscsiErr: function(e) {
             console.log(this.is + ":" + arguments.callee.name + ": caught " + e.type);

             alert("Failed to obtain iSCSI data from server.");
             this.getIscsiDataButtonDisabled = false;
         },

         _iscsiImagesChanged: function(changeRecord) {
             console.log(this.is + ":" + arguments.callee.name + ": updated RBD image list");

             /* Walk the targetList and notify all targets. */
             for (var i = 0; i < this.targetList.length; i++) {
                 var target = this.targetList[i];
                 target.notifyPath("availableImgList", this.availableImgList.slice());
             }
         },

         _iscsiInterfacesChanged: function(changeRecord) {
             console.log(this.is + ":" + arguments.callee.name + ": updated interfaces list");

             /* Walk the targetList and notify all targets. */
             for (var i = 0; i < this.targetList.length; i++) {
                 var target = this.targetList[i];
                 target.notifyPath("availableIntfList", this.availableIntfList.slice());
             }
         },

         displayGenerateConfigFileButton: function() {
             /* Button is only active/displayed if targets exist. */
             if (this.targetList.length)
                 this.generateConfigFileButtonHidden = false;
             else
                 this.generateConfigFileButtonHidden = true;
         },

         newTarget: function() {
             var target = document.createElement("iscsi-target");
             this.push("targetList", target);
             target.set("availableImgList", this.availableImgList);
             target.set("availableIntfList", this.availableIntfList);

             /* Note: this.$['...'] is the equivalent of document.getElementById("generate-config-file-button");
              * If element id is a single word, this.$.id can be used.  Further, this.$.generateConfigFileButton
              * _should_ be sufficient, but does not appear to work and is documented as a bug with the workaround
              * being this.$['...']
              */
             Polymer.dom(this.root).insertBefore(target, this.$["generate-config-file-button"]);
             this.displayGenerateConfigFileButton();
         },

         generateConfigFile: function() {
             console.log("================================================================");
             console.log("generateConfigFile():");
             for (var i = 0; i < this.targetList.length; i++) {
                 console.log("target: " + this.targetList[i].name);
                 for (var j = 0; j < this.targetList[i].configList.length; j++) {
                     console.log("----------------------------------------------------------------");
                     console.log("config " + j + ": " + this.targetList[i].configList[j]);
                     console.log("selected interfaces:")
                     for (var k = 0; k < this.targetList[i].configList[j].selectedIntfList.length; k++) {
                         console.log(this.targetList[i].configList[j].selectedIntfList[k]);
                     }
                     console.log("selected images:")
                     for (var l = 0; l < this.targetList[i].configList[j].selectedImgList.length; l++) {
                         console.log(this.targetList[i].configList[j].selectedImgList[l]);
                     }
                     console.log("auth: " + this.targetList[i].configList[j].auth);
                     if (this.targetList[i].configList[j].auth) {
                         console.log("userid: " + this.targetList[i].configList[j].auth.userid);
                         console.log("password: " + this.targetList[i].configList[j].auth.password);
                     }
                     if (this.targetList[i].configList[j].auth && this.targetList[i].configList[j].auth.initiatorList) {
                         console.log("initiators: " + this.targetList[i].configList[j].auth.initiatorList);
                     }
                     if (this.targetList[i].configList[j].auth && this.targetList[i].configList[j].auth.mutualAuth) {
                         console.log("Mutual auth userid: " + this.targetList[i].configList[j].auth.mutualAuth.userid);
                         console.log("Mutual auth password: " + this.targetList[i].configList[j].auth.mutualAuth.password);
                         console.log("Mutual auth enabled: " + this.targetList[i].configList[j].auth.mutualAuth.enabled);
                     }
                     if (this.targetList[i].configList[j].auth && this.targetList[i].configList[j].auth.discoveryAuth) {
                         console.log("Discovery auth userid: " + this.targetList[i].configList[j].auth.discoveryAuth.userid);
                         console.log("Discovery auth password: " + this.targetList[i].configList[j].auth.discoveryAuth.password);
                         console.log("Discovery auth enabled: " + this.targetList[i].configList[j].auth.discoveryAuth.enabled);
                         if (this.targetList[i].configList[j].auth.discoveryAuth.mutualAuth) {
                             console.log("Discovery mutual auth userid: " + this.targetList[i].configList[j].auth.discoveryAuth.mutualAuth.userid);
                             console.log("Discovery mutual auth password: " + this.targetList[i].configList[j].auth.discoveryAuth.mutualAuth.password);
                             console.log("Discovery mutual auth enabled: " + this.targetList[i].configList[j].auth.discoveryAuth.mutualAuth.enabled);
                         }
                     }
                 }
                 console.log("----------------------------------------------------------------");
             }
             console.log("================================================================");
         }
     });
    </script>
</dom-module>
