<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../iscsi-target/iscsi-target.html">

<dom-module id="iscsi-conf">
    <template>
        <style>
         :host {
             display: block;

             padding: 10px 20px;
         }

         .add-target-button {
             width: 50px;
             height: 50px;
         }

         .generate-config-file-button {
             background: #85aa94
         }
        </style>

        <h1>iSCSI Targets</h1>
        <paper-icon-button title="Add a new iSCSI target" class="add-target-button" icon="add" on-tap="newTarget">Add Target</paper-icon-button>
        <br>
        <paper-button raised on-click="generateConfigFile" id="generate-config-file-button"
                      class="generate-config-file-button" icon="add" hidden$="{{generateConfigFileButtonHidden}}">
            Generate LRBD Config
        </paper-button>
    </template>

    <script>
     Polymer({
         is: 'iscsi-conf',
         properties: {
             targetList: {
                 type: Array,
                 value: [],
             },

             generateConfigFileButtonHidden: {
                 type: Boolean,
                 value: true,
             },

	     availableImgList: {
		 type: Array,
		 value: function() {
		     return [
			 {"img": "img-foo1", "pool": "pool-rbd1"},
			 {"img": "img-foo2", "pool": "pool-rbd1"},
			 {"img": "img-foo3", "pool": "pool-rbd2"},
			 {"img": "img-foo4", "pool": "pool-rbd3"},
			 {"img": "img-foo5", "pool": "pool-rbd3"}
		     ];
		 },
		 notify: true
	     },

	     availableIntfList: {
		 type: Array,
		 value: function() {
		     return [
			 {"addr": "192.168.1.10", "node": "igw1.foobar.com"},
			 {"addr": "192.168.1.11", "node": "igw2.foobar.com"},
			 {"addr": "192.168.1.12", "node": "igw3.foobar.com"},
			 {"addr": "192.168.1.13", "node": "igw4.foobar.com"},
			 {"addr": "192.168.1.14", "node": "igw5.foobar.com"}
		     ];
		 },
		 notify: true
	     }
         },

	 observers: [
	     "_iscsiImagesChanged(availableImgList.splices)",
	     "_iscsiInterfacesChanged(availableIntfList.splices)"
	 ],

         ready: function() {
             this.addEventListener('removeTarget', function(e) {
                 console.debug("Removing target: " + e.target.name);
                 /* Remove from view. */
                 this.removeChild(e.target);

                 /* Remove from targetList array. */
                 var index = this.targetList.indexOf(e.target);
                 if (index > -1) {
                     this.targetList.splice(index, 1);
                 }
                 this.displayGenerateConfigFileButton();
             });
         },

         _iscsiImagesChanged: function(changeRecord) {
             console.log(this.is + ":" + arguments.callee.name + ": updated RBD image list");

             if (changeRecord) {
                 changeRecord.indexSplices.forEach(function(s) {
                     s.removed.forEach(function(img) {
                         console.log(img.img + ":" + img.pool + " removed");
                     });
                     for (var i=0; i<s.addedCount; i++) {
                         var index = s.index + i;
                         var newImg = s.object[index];
                         console.log(newImg.img + " added at index " + index);
                     }
                 }, this);

                 /* Walk the targetList and notify all targets. */
                 for (var i = 0; i < this.targetList.length; i++) {
                     var target = this.targetList[i];
                     target.notifyPath("availableImgList", this.availableImgList.slice());
                 }
             }
         },

         _iscsiInterfacesChanged: function(changeRecord) {
             console.log(this.is + ":" + arguments.callee.name + ": updated interfaces list");

             if (changeRecord) {
                 changeRecord.indexSplices.forEach(function(s) {
                     s.removed.forEach(function(intf) {
                         console.log(intf.node + ":" + intf.addr + " removed");
                     });
                     for (var i=0; i<s.addedCount; i++) {
                         var index = s.index + i;
                         var newIntf = s.object[index];
                         console.log(newIntf + " added at index " + index);
                     }
                 }, this);

                 /* Walk the targetList and notify all targets. */
                 for (var i = 0; i < this.targetList.length; i++) {
                     var target = this.targetList[i];
                     target.notifyPath("availableIntfList", this.availableIntfList.slice());
                 }
             }
         },

         displayGenerateConfigFileButton: function() {
             /* Button is only active/displayed if targets exist. */
             if (this.targetList.length)
                 this.generateConfigFileButtonHidden = false;
             else
                 this.generateConfigFileButtonHidden = true;
         },

         newTarget: function() {
             var target = document.createElement("iscsi-target");
             this.push("targetList", target);
             target.set("availableImgList", this.availableImgList);
             target.set("availableIntfList", this.availableIntfList);

             /* Note: this.$['...'] is the equivalent of document.getElementById("generate-config-file-button");
              * If element id is a single word, this.$.id can be used.  Further, this.$.generateConfigFileButton
              * _should_ be sufficient, but does not appear to work and is documented as a bug with the workaround
              * being this.$['...']
              */
             Polymer.dom(this.root).insertBefore(target, this.$["generate-config-file-button"]);
             this.displayGenerateConfigFileButton();
         },

         generateConfigFile: function() {
             console.log("================================================================");
             console.log("generateConfigFile():");
             for (var i = 0; i < this.targetList.length; i++) {
                 console.log("target: " + this.targetList[i].name);
                 for (var j = 0; j < this.targetList[i].configList.length; j++) {
                     console.log("----------------------------------------------------------------");
                     console.log("config " + j + ": " + this.targetList[i].configList[j]);
                     console.log("selected interfaces:")
                     for (var k = 0; k < this.targetList[i].configList[j].selectedIntfList.length; k++) {
                         console.log(this.targetList[i].configList[j].selectedIntfList[k]);
                     }
                     console.log("selected images:")
                     for (var l = 0; l < this.targetList[i].configList[j].selectedImgList.length; l++) {
                         console.log(this.targetList[i].configList[j].selectedImgList[l]);
                     }
                     console.log("auth: " + this.targetList[i].configList[j].auth);
                     if (this.targetList[i].configList[j].auth) {
                         console.log("userid: " + this.targetList[i].configList[j].auth.userid);
                         console.log("password: " + this.targetList[i].configList[j].auth.password);
                     }
                     if (this.targetList[i].configList[j].auth && this.targetList[i].configList[j].auth.initiatorList) {
                         console.log("initiators: " + this.targetList[i].configList[j].auth.initiatorList);
                     }
                     if (this.targetList[i].configList[j].auth && this.targetList[i].configList[j].auth.mutualAuth) {
                         console.log("Mutual auth userid: " + this.targetList[i].configList[j].auth.mutualAuth.userid);
                         console.log("Mutual auth password: " + this.targetList[i].configList[j].auth.mutualAuth.password);
                         console.log("Mutual auth enabled: " + this.targetList[i].configList[j].auth.mutualAuth.enabled);
                     }
                     if (this.targetList[i].configList[j].auth && this.targetList[i].configList[j].auth.discoveryAuth) {
                         console.log("Discovery auth userid: " + this.targetList[i].configList[j].auth.discoveryAuth.userid);
                         console.log("Discovery auth password: " + this.targetList[i].configList[j].auth.discoveryAuth.password);
                         console.log("Discovery auth enabled: " + this.targetList[i].configList[j].auth.discoveryAuth.enabled);
                         if (this.targetList[i].configList[j].auth.discoveryAuth.mutualAuth) {
                             console.log("Discovery mutual auth userid: " + this.targetList[i].configList[j].auth.discoveryAuth.mutualAuth.userid);
                             console.log("Discovery mutual auth password: " + this.targetList[i].configList[j].auth.discoveryAuth.mutualAuth.password);
                             console.log("Discovery mutual auth enabled: " + this.targetList[i].configList[j].auth.discoveryAuth.mutualAuth.enabled);
                         }
                     }
                 }
                 console.log("----------------------------------------------------------------");
             }
             console.log("================================================================");
         }
     });
    </script>
</dom-module>
