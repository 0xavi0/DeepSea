<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../iscsi-target/iscsi-target.html">
<link rel="import" href="../salt-api/wf-salt-api.html">

<script src="lrbdutils.js"></script>

<dom-module id="iscsi-conf">
    <template>
        <style>
         :host {
             display: block;

             padding: 10px 20px;
         }

         .add-target-button {
             width: 50px;
             height: 50px;
         }

         .generate-config-file-button {
             background: #85aa94
         }
        </style>

        <h1>iSCSI Targets</h1>
        <paper-icon-button title="Add a new iSCSI target" class="add-target-button" icon="add" on-tap="newTarget">Add Target</paper-icon-button>

        <paper-button id="get-iscsi-data-button" raised on-click="_getIscsiData"
                      disabled$="{{getIscsiDataButtonDisabled}}">Query iSCSI Data
            <paper-spinner active$="{{getIscsiDataButtonDisabled}}" hidden$="{{!getIscsiDataButtonDisabled}}">
            </paper-spinner>
        </paper-button>
        <br>
        <paper-button raised on-click="generateConfigFile" id="generate-config-file-button"
                      class="generate-config-file-button" icon="add" hidden$="{{generateConfigFileButtonHidden}}" disabled$="{{generateConfigFileButtonDisabled}}">
            Generate LRBD Config
        </paper-button>

        <!-- Query interfaces and images from salt-api backend. -->
        <wf-salt-api
            id="populateiscsi"
            cmd=""
            arg=""
            target=""
            func="ui.populate_iscsi"
            data=""
            canned="1">
	</wf-salt-api>

        <!-- Query interfaces and images from salt-api backend. -->
        <wf-salt-api
            id="saveiscsi"
            cmd=""
            arg=""
            target=""
            func="ui.save_iscsi"
            data=""
            canned="1">
	</wf-salt-api>
    </template>

    <script>
     Polymer({
         is: 'iscsi-conf',
         properties: {
             targetList: {
                 type: Array,
                 value: [],
             },

             generateConfigFileButtonHidden: {
                 type: Boolean,
                 value: true,
             },

             generateConfigFileButtonDisabled: {
                 type: Boolean,
                 value: false
             },

	     availableImgList: {
		 type: Array,
		 value: function() {
		     return [];
		 },
		 notify: true
	     },

	     availableIntfList: {
		 type: Array,
		 value: function() {
		     return [];
		 },
		 notify: true
	     },

             getIscsiDataButtonDisabled: {
                 type: Boolean,
                 value: true
             },

             lrbdConf: {
                 type: LRBDConf,
             }
         },

	 observers: [
	     "_iscsiImagesChanged(availableImgList.splices)",
	     "_iscsiInterfacesChanged(availableIntfList.splices)"
	 ],

         listeners: {
	     "wf-salt-api-response": "handleIscsi200",
	     "wf-salt-api-error": "handleIscsiErr"
	 },

         ready: function() {
             this.addEventListener('removeTarget', function(e) {
                 console.debug("Removing target: " + e.target.name);
                 /* Remove from view. */
                 this.removeChild(e.target);

                 /* Remove from targetList array. */
                 var index = this.targetList.indexOf(e.target);
                 if (index > -1) {
                     this.targetList.splice(index, 1);
                 }
                 this.displayGenerateConfigFileButton();
             });

             /* On load, try to populate iSCSI data. */
             this._getIscsiData();

             /* Create an empty LRBD Config.  Population needs to wait until we
              * have obtained data from salt-api.
              */
             this.lrbdConf = new LRBDConf();
         },

         /* Takes an array of { "img": "", "pool": "" } and returns an
          * array of iscsi-conf-target:{Image}.
          */
         _parseImgData: function(imgDataArr) {
             var imageArr = [];
             for (var i = 0; i < imgDataArr.length; i++) {
                 var img = imgDataArr[i].img;
                 var pool = imgDataArr[i].pool;
                 imageArr.push(new Image(img, pool));
             }
             return imageArr;
         },

         /* Takes an array of { "node": "", "addr": "" } and returns an
          * array of iscsi-conf-target:{Interface}.
          */
         _parseIntfData: function(intfDataArr) {
             var interfaceArr = [];
             for (var i = 0; i < intfDataArr.length; i++) {
                 var node = intfDataArr[i].node;
                 var addr = intfDataArr[i].addr;
                 interfaceArr.push(new Interface(node, addr));
             }
             return interfaceArr;
         },

         /* Invokes the populateiscsi wf-salt-api ajax call. */
         _getIscsiData: function() {
             console.log(this.is + ":" + arguments.callee.name + ": updating iSCSI data");

             /* Disable load button and enable spinner. */
             this.getIscsiDataButtonDisabled = true;

             /* Try to get some data. */
             this.$.populateiscsi.runPost();
         },

         handleIscsi200: function(e) {
             console.log(this.is + ":" + arguments.callee.name + ": caught " + e.type);

             if (e.target === this.$.populateiscsi) {
                 console.log(this.is + ":" + arguments.callee.name + ": populating image and interface lists");

                 var resp = e.detail.response.return[0];
                 this.getIscsiDataButtonDisabled = false;

                 /* TODO: do we want to load the config, even if there are no available images/interfaces? */
                 if (!resp.interfaces || !resp.images) {
                     alert("Invalid iSCSI data returned from server.");
                 } else {
                     this.set("availableImgList", this._parseImgData(resp.images));
                     this.set("availableIntfList", this._parseIntfData(resp.interfaces));
                     this.lrbdConf.populateFromFile(resp.config);
                 }
             } else if (e.target === this.$.saveiscsi) {
                 this.generateConfigFileButtonDisabled = false;
             }
         },

         handleIscsiErr: function(e) {
             console.log(this.is + ":" + arguments.callee.name + ": caught " + e.type);

             if (e.target === this.$.populateiscsi) {
                 alert("Failed to obtain iSCSI data from server.");
                 this.getIscsiDataButtonDisabled = false;
             } else if (e.target === this.$.saveiscsi) {
                 alert("Failed to push iSCSI configuration to server.");
                 this.generateConfigFileButtonDisabled = false;
             }
         },

         _iscsiImagesChanged: function(changeRecord) {
             console.log(this.is + ":" + arguments.callee.name + ": updated RBD image list");

             /* Walk the targetList and notify all targets. */
             for (var i = 0; i < this.targetList.length; i++) {
                 var target = this.targetList[i];
                 target.notifyPath("availableImgList", this.availableImgList.slice());
             }
         },

         _iscsiInterfacesChanged: function(changeRecord) {
             console.log(this.is + ":" + arguments.callee.name + ": updated interfaces list");

             /* Walk the targetList and notify all targets. */
             for (var i = 0; i < this.targetList.length; i++) {
                 var target = this.targetList[i];
                 target.notifyPath("availableIntfList", this.availableIntfList.slice());
             }
         },

         displayGenerateConfigFileButton: function() {
             /* Button is only active/displayed if targets exist. */
             if (this.targetList.length)
                 this.generateConfigFileButtonHidden = false;
             else
                 this.generateConfigFileButtonHidden = true;
         },

         newTarget: function() {
             var target = document.createElement("iscsi-target");
             this.push("targetList", target);
             target.set("availableImgList", this.availableImgList.slice());
             target.set("availableIntfList", this.availableIntfList.slice());
             target.set("customTargetEntries", JSON.stringify({"foo":"bar", "baz":"buz"}, null, 2));

             /* Note: this.$['...'] is the equivalent of document.getElementById("generate-config-file-button");
              * If element id is a single word, this.$.id can be used.  Further, this.$.generateConfigFileButton
              * _should_ be sufficient, but does not appear to work and is documented as a bug with the workaround
              * being this.$['...']
              */
             Polymer.dom(this.root).insertBefore(target, this.$["generate-config-file-button"]);
             this.displayGenerateConfigFileButton();
         },

         generateConfigFile: function() {
             /* Only allow once in-flight attempt at a time. */
             this.generateConfigFileButtonDisabled = true;

             if (!this.lrbdConf.populateFromUI(this.targetList)) {
                 console.error("Failed to populate " + this.lrbdConf + " from the UI.");
                 alert("Failed to generate an LRBD configuration.");
                 this.generateConfigFileButtonDisabled = false;
             } else {
                 /* Try to actually save LRBDConf.
                  * Note that cherrypy searches for "arg" in request body:
                  * netapi/rest_cherrypy/app.py:lowdata_fmt().  If sent as plain text,
                  * "targets", etc in lrbdConf will trigger a match and a subsequent traceback
                  * when cherrypy tries to access data['arg'] as if it were a valid dictionary
                  * key.  URI encoding remedies this, however, it would be safer to also
                  * replace all instances of 'a' with '%61' after the encoding pass.
                  */
                 this.$.saveiscsi.data = encodeURIComponent(JSON.stringify(this.lrbdConf, null, 2));
                 this.$.saveiscsi.runPost();
             }
         }
     });
    </script>
</dom-module>
