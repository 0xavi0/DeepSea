<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../wf-styles/wf-styles.html">

<link rel="import" href="iscsi-target-config.html">
<link rel="import" href="iscsi-target-styles.html">

<dom-module id="iscsi-target">
    <template>
	<style include="wf-styles iscsi-target-styles">
         :host {
             display: block;

             padding: 10px;
         }
        </style>

	<div class="wf-card">
	    <paper-toolbar class="wf-card-toolbar">
                <span class="title">{{name}}</span>
                <paper-icon-button icon="delete" on-tap="removeTarget"></paper-icon-button>
            </paper-toolbar>
            <br>
            Target: <input is="iron-input" bind-value="{{name}}">
            <br>
            <br>

            <div>
                <div class="target-add-config">
                    <paper-button raised on-click="addConfig"><iron-icon icon="add"></iron-icon>Config</paper-button>
                </div>
            </div>
        </div>
    </template>

    <script>
     Polymer({
         is: 'iscsi-target',
         properties: {
             name: {
                 type: String,
                 value: function() {
                     /* sample: iqn.2017-0-12-105418265.org.linux-iscsi.igw.x86 */
                     /* TODO: Should we also auto-gen a ":some-suffix" (ie. :sn-redundant, etc)? */
                     var d = new Date();
                     return "iqn." + d.getFullYear() + "-" + d.getMonth() + "-" + d.getDate() + "-" +
                            d.getHours() + d.getMinutes() + d.getSeconds() + d.getMilliseconds() +
                            ".org.linux-iscsi.igw.x86";
                 },
             },
             configList: {
                 type: Array,
                 value: function() {
                     /* Must be returned as a function otherwise will be shared across all instances. */
                     return [];
                 },
             },
	     /* Follows iscsi-conf:availableImgList.  Do not modify here. */
	     availableImgList: {
		 type: Array,
		 notify: true
	     },
	     /* Follows iscsi-conf:availableIntfList.  Do not modify here. */
	     availableIntfList: {
		 type: Array,
		 notify: true
	     }
         },

	 observers: [
	     "_iscsiImagesChanged(availableImgList.splices)",
	     "_iscsiInterfacesChanged(availableIntfList.splices)"
	 ],

         ready: function() {
             this.addEventListener("removeConfig", function(e) {
                 console.debug("Removing config: " + e.target);
                 /* Remove from view. */
                 /* TODO: Works, but triggers an error message in the debugger:
                  *   TypeError: Argument 1 of Node.contains does not implement interface Node.
                  */
                 var targetConfigDiv = document.getElementById("target-config-div");
                 Polymer.dom(this.firstElementChild).removeChild(e.target);

                 /* Remove from targetList array.*/
                 var index = this.configList.indexOf(e.target);
                 if (index > -1) {
                     this.configList.splice(index, 1);
                 }
             });
         },

         _iscsiImagesChanged: function(changeRecord) {
             /* NOTE: changeRecord is always undefined here. */
             console.log(this.is + ":" + arguments.callee.name + ": updated RBD image list");

             for (var i = 0; i < this.configList.length; i++) {
                 var targetConfig = this.configList[i];
                 targetConfig.notifyPath("availableImgList", this.availableImgList.slice());
             }
         },

         _iscsiInterfacesChanged: function(changeRecord) {
             /* NOTE: changeRecord is always undefined here. */
             console.log(this.is + ":" + arguments.callee.name + ": updated interface list");

             for (var i = 0; i < this.configList.length; i++) {
                 var targetConfig = this.configList[i];
                 targetConfig.notifyPath("availableIntfList", this.availableIntfList.slice());
             }
         },

         removeTarget: function() {
             this.fire('removeTarget');
         },

         addConfig: function() {
             var targetConfig = document.createElement("iscsi-target-config");
             targetConfig.set("availableImgList", this.availableImgList);
             targetConfig.set("availableIntfList", this.availableIntfList);
             this.push("configList", targetConfig);
             /* var beforeNode = Polymer.dom(this.root).childNodes[-1];*/
             Polymer.dom(this.firstElementChild).appendChild(targetConfig);

         }         
     });
    </script>
</dom-module>
