<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../wf-styles/wf-styles.html">

<link rel="import" href="iscsi-target-styles.html">

<dom-module id="iscsi-target-config">
    <template>
	<style include="wf-styles iscsi-target-styles">
         :host {
             display: block;

             padding: 10px;
         }
        </style>

	<div class="wf-card target-config-card">
            <paper-toolbar class="target-config-toolbar">
                <span class="title">iSCSI Target Configuration</span>
                <paper-icon-button icon="delete" on-tap="removeConfig"></paper-icon-button>
            </paper-toolbar>

            <paper-dropdown-menu label="Available Nodes">
                <div class="dropdown-content">
                    <template is="dom-repeat" items="{{availableIntfList}}" as="i">
                        <paper-item><paper-checkbox on-change="nodeCheckboxChanged">{{i.node}} : {{i.addr}}</paper-checkbox></paper-item>
                    </template>
                </div>
            </paper-dropdown-menu>

            <paper-dropdown-menu label="Available Images">
                <div class="dropdown-content">
                    <template is="dom-repeat" items="{{availableImgList}}" as="i">
                        <paper-item><paper-checkbox on-change="imgCheckboxChanged">{{i.img}} : {{i.pool}}</paper-checkbox></paper-item>
                    </template>
                </div>
            </paper-dropdown-menu>

            <paper-dropdown-menu label="Authentication Protocol" >
                <paper-listbox class="dropdown-content" selected="0">
                    <template is="dom-repeat" items="{{authTypes}}" as="a">
                        <!-- Actual authentication classes have a 'desc' class property. -->
                        <template is="dom-if" if="{{a.desc}}">
                            <paper-item on-click="configureAuth">{{a.desc}}</paper-item>
                        </template>
                        <!-- The 'no auth' option. -->
                        <template is="dom-if" if="{{!a.desc}}">
                            <paper-item on-click="configureAuth">{{a}}</paper-item>
                        </template>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>

            <paper-dialog id='addCommonAuthDialog' class="target-config-auth-dialog">
                <paper-input label='userid' value='{{userid}}'></paper-input>
                <paper-input label='password' value='{{password}}'></paper-input>

                <paper-checkbox on-change="initiatorInputCheckboxChanged">Add initiators (optional)</paper-checkbox>
                <div hidden$="{{initiatorInputHidden}}">
                    <label>Initiators (one per line)</label>
                    <br>
                    <iron-autogrow-textarea class="paper-input-input" max-rows="5" rows="5" value="{{initiatorList}}"></iron-autogrow-textarea>
                </div>
                <br>
                <hr>
                <paper-checkbox on-change="mutInputCheckboxChanged">Add mutual authentication (optional)</paper-checkbox>
                <div hidden$="{{mutInputHidden}}">
                    <paper-input label='Mutual userid' value='{{mutUserId}}'></paper-input>
                    <paper-input label='Mutual password' value='{{mutPassword}}'></paper-input>
                    <paper-checkbox on-change="mutEnabledCheckboxChanged" checked="{{mutEnabled}}">Mutual authentication enabled (default)</paper-checkbox>
                </div>
                <br>
                <hr>
                <paper-checkbox on-change="discInputCheckboxChanged">Add discovery authentication (optional)</paper-checkbox>
                <div hidden$="{{discInputHidden}}">
                    <paper-input label='Discovery userid' value='{{discUserId}}'></paper-input>
                    <paper-input label='Discovery password' value='{{discPassword}}'></paper-input>
                    <paper-checkbox on-change="discEnabledCheckboxChanged" checked="{{discEnabled}}">Discovery authentication enabled (default)</paper-checkbox>
                    <br>
                    <paper-checkbox on-change="discMutInputCheckboxChanged">Add discovery mutual authentication (optional)</paper-checkbox>
                    <div hidden$="{{discMutInputHidden}}">
                        <paper-input label='Discovery mutual userid' value='{{discMutUserId}}'></paper-input>
                        <paper-input label='Discovery mutual password' value='{{discMutPassword}}'></paper-input>
                        <paper-checkbox on-change="discMutEnabledCheckboxChanged" checked="{{discMutEnabled}}">Mutual authentication enabled (default)</paper-checkbox>
                    </div>
                </div>
                <div class='buttons'>
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button on-click='addCommonAuth'>Add</paper-button>
                </div>
            </paper-dialog>

            <br>
            <br>

            <paper-listbox class="dropdown-content" selected="0" style="float:left" hidden$="{{selectedIntfListHidden}}">
                <span class="title">Selected Nodes</span>
                <template is="dom-repeat" items="{{selectedIntfList}}" as="i">                
                    <paper-item>{{i.node}} : {{i.addr}}</paper-item>
                </template>
            </paper-listbox>

            <paper-listbox class="dropdown-content" selected="0" style="float:left" hidden$="{{selectedImgListHidden}}">
                <span class="title">Selected Images</span>
                <template is="dom-repeat" items="{{selectedImgList}}" as="i">                
                    <paper-item>{{i.img}} : {{i.pool}}</paper-item>
                </template>
            </paper-listbox>

            <paper-listbox class="dropdown-content" selected="0" style="float:left" hidden$="{{authHidden}}">
                <span class="title">Configured Authentication Protocol</span>
                <template is="dom-if" if="{{auth}}">
                    <paper-item>{{auth}}</paper-item>
                    <paper-item class="target-config-auth-item">userid: {{auth.userid}}</paper-item>
                    <paper-item class="target-config-auth-item">password: {{auth.password}}</paper-item>
                    <template is="dom-if" if="{{auth.initiatorList.length}}">
                        <paper-item class="target-config-auth-item">initiators:</paper-item>
                        <template is="dom-repeat" items="{{auth.initiatorList}}" as="i">
                            <!-- Further nest initiator elements under label. -->
                            <paper-item class="target-config-auth-item" style="margin-left:2em">{{i}}</paper-item>
                        </template>
                    </template>
                    <template is="dom-if" if="{{auth.mutualAuth}}">
                        <paper-item class="target-config-auth-item">Mutual authentication:</paper-item>
                        <paper-item class="target-config-auth-item" style="margin-left:2em">userid: {{auth.mutualAuth.userid}}</paper-item>
                        <paper-item class="target-config-auth-item" style="margin-left:2em">password: {{auth.mutualAuth.password}}</paper-item>
                        <paper-item class="target-config-auth-item" style="margin-left:2em">enabled: {{auth.mutualAuth.enabled}}</paper-item>
                    </template>
                    <template is="dom-if" if="{{auth.discoveryAuth}}">
                        <paper-item class="target-config-auth-item">Discovery authentication:</paper-item>
                        <paper-item class="target-config-auth-item" style="margin-left:2em">userid: {{auth.discoveryAuth.userid}}</paper-item>
                        <paper-item class="target-config-auth-item" style="margin-left:2em">password: {{auth.discoveryAuth.password}}</paper-item>
                        <paper-item class="target-config-auth-item" style="margin-left:2em">enabled: {{auth.discoveryAuth.enabled}}</paper-item>
                        <template is="dom-if" if="{{auth.discoveryAuth.mutualAuth}}">
                            <paper-item class="target-config-auth-item" style="margin-left:2em">Discovery mutual authentication:</paper-item>
                            <paper-item class="target-config-auth-item" style="margin-left:3em">userid: {{auth.discoveryAuth.mutualAuth.userid}}</paper-item>
                            <paper-item class="target-config-auth-item" style="margin-left:3em">password: {{auth.discoveryAuth.mutualAuth.password}}</paper-item>
                            <paper-item class="target-config-auth-item" style="margin-left:3em">enabled: {{auth.discoveryAuth.mutualAuth.enabled}}</paper-item>
                        </template>
                    </template>
                </template>
            </paper-listbox>
        </div>
    </template>

    <script>

     /* All auths mechanisms stem from here. */
     class BaseAuth {
         constructor(userid, password) {
             this.userid = userid;
             this.password = password;
         }
     }

     /* Used within CommonAuth and DiscoveryAuth*/
     class MutualAuthFrag extends BaseAuth {
         constructor(userid, password, enabled) {
             super(userid, password);
             this.enabled = enabled;
         }
     }

     class DiscoveryAuthFrag extends MutualAuthFrag {
         constructor(userid, password, enabled, mutualAuth) {
             super(userid, password, enabled);
             this.mutualAuth = mutualAuth;
         }
     }

     /* The simplest auth available to be configured by the user. */
     class CommonAuth extends BaseAuth {
         constructor(userid, password, initiatorList, mutualAuth, discoveryAuth) {
             super(userid, password);
             this.initiatorList = initiatorList;
             this.mutualAuth = mutualAuth;
             this.discoveryAuth = discoveryAuth;
         }

         toString() {
             return "Common authentication";
         }
     }
     /* Class properties and prototype data properties need be created outside the declaration. */
     CommonAuth.desc = "Common authentication";

     Polymer({
         is: 'iscsi-target-config',
         properties: {
             availableIntfList: {
                 type: Array,
                 value: function() {
                     /* TODO Should poll salt for interface list (via salt-api/cherrypy */
                     return [
                         {"addr": "192.168.1.10", "node": "igw1.foobar.com"},
                         {"addr": "192.168.1.11", "node": "igw2.foobar.com"},
                         {"addr": "192.168.1.12", "node": "igw3.foobar.com"},
                         {"addr": "192.168.1.13", "node": "igw4.foobar.com"},
                         {"addr": "192.168.1.14", "node": "igw5.foobar.com"}
                     ];
                 },
             },

             selectedIntfListHidden: {
                 type: Boolean,
                 value: true,
             },
             
             selectedIntfList: {
                 type: Array,
                 value: function() {
                     return [];
                 },
             },

             availableImgList: {
                 type: Array,
                 value: function() {
                     /* TODO Should poll salt for img list (via salt-api/cherrypy */
                     return [
                         {"img": "img-foo1", "pool": "pool-rbd1"},
                         {"img": "img-foo2", "pool": "pool-rbd1"},
                         {"img": "img-foo3", "pool": "pool-rbd2"},
                         {"img": "img-foo4", "pool": "pool-rbd3"},
                         {"img": "img-foo5", "pool": "pool-rbd3"}
                     ];
                 },
             },

             selectedImgListHidden: {
                 type: Boolean,
                 value: true,
             },
             
             selectedImgList: {
                 type: Array,
                 value: function() {
                     return [];
                 },
             },

             authTypes: {
                 type: Array,
                 /* Could also be [null,CommonAuth..], but this way I can more uniformly display in the template. */
                 value: [ {"type": null, "desc": "No authentication"},
                          {"type": CommonAuth, "desc": CommonAuth.desc},
                 ]
             },

             auth: {
                 type: Object,
                 value: function() {
                     /* Default is no auth (ie. an empty object). */
                     return null;
                 }
             },

             /* Only display auth if not null. */
             authHidden: {
                 type: Boolean,
                 value: true,
             },

             userid: {
                 type: String,
                 value: "",
             },

             password: {
                 type: String,
                 value: "",
             },

             initiatorList: {
                 type: Array,
                 value: function() {
                     return [];
                 },
             },

             initiatorInputHidden: {
                 type: Boolean,
                 value: true,
             },

             /* Mutual auth related elements.  Mutual auth is contained within the context of
              * an auth instance.
              */
             mutUserId: {
                 type: String,
                 value: "",
             },
             mutPassword: {
                 type: String,
                 value: "",
             },
             mutEnabled: {
                 type: Boolean,
                 value: false,
             },
             mutInputHidden: {
                 type: Boolean,
                 value: true,
             },

             /* Discovery auth related elements.  Discovery auth is contained within the context of
              * an auth instance.
              */
             discUserId: {
                 type: String,
                 value: "",
             },
             discPassword: {
                 type: String,
                 value: "",
             },
             discEnabled: {
                 type: Boolean,
                 value: false,
             },
             discInputHidden: {
                 type: Boolean,
                 value: true,
             },
             discMutUserId: {
                 type: String,
                 value: "",
             },
             discMutPassword: {
                 type: String,
                 value: "",
             },
             discMutEnabled: {
                 type: Boolean,
                 value: false,
             },
             discMutInputHidden: {
                 type: Boolean,
                 value: true,
             },
         },

         ready: function() {
             /* TBD */
         },

         removeConfig: function() {
             this.fire("removeConfig");
         },

         nodeCheckboxChanged: function(e) {
             var intf = e.model.__data__.i;
             console.log("nodeCheckboxChanged()");
             if (e.target.checked) {
                 console.log(intf.node + ":" + intf.addr + " selected - adding to selected list.");
                 this.push("selectedIntfList", intf);
             } else {
                 console.log(intf.node + ":" + intf.addr + " deselected - removing from selected list.");
                 var index = this.selectedIntfList.indexOf(intf);
                 this.splice("selectedIntfList", index, 1);
             }

             /* Check if we should hide the selected list */
             if (this.selectedIntfList.length > 0) {
                 this.selectedIntfListHidden = false;
             } else {
                 this.selectedIntfListHidden = true;
             }
         },

         imgCheckboxChanged: function(e) {
             var img = e.model.__data__.i;
             console.log("imgCheckboxChanged()");
             if (e.target.checked) {
                 console.log(img.img + ":" + img.pool + " selected - adding to selected list.");
                 this.push("selectedImgList", img);
             } else {
                 console.log(img.img + ":" + img.pool + " deselected - removing from selected list.");
                 var index = this.selectedImgList.indexOf(img);
                 this.splice("selectedImgList", index, 1);
             }

             /* Check if we should hide the selected list */
             if (this.selectedImgList.length > 0) {
                 this.selectedImgListHidden = false;
             } else {
                 this.selectedImgListHidden = true;
             }
         },

         initiatorInputCheckboxChanged: function(e) {
             console.log("initiatorInputCheckboxChanged()");
             if (e.target.checked) {
                 console.log("Initiator input activated.");
                 this.initiatorInputHidden = false;
                 this.$.addCommonAuthDialog.center();
             } else {
                 console.log("Initiator input de-activated.");
                 this.initiatorInputHidden = true;
                 this.$.addCommonAuthDialog.center();
                 /* Clear bound vars. */
                 this.initiatorList = [];
             }
         },

         mutInputCheckboxChanged: function(e) {
             console.log("mutInputCheckboxChanged()");
             if (e.target.checked) {
                 console.log("Mutual input activated.");
                 this.mutInputHidden = false;
                 this.$.addCommonAuthDialog.center();
                 /* Enabling mutual auth input auto-enables mutual auth. */
                 this.mutEnabled = true;
             } else {
                 console.log("Mutual input de-activated.");
                 this.mutInputHidden = true;
                 this.$.addCommonAuthDialog.center();
                 /* Disabling mutual auth input auto-disables mutual auth. */
                 this.mutEnabled = false;
                 /* Clear bound vars. */
                 this.mutUserId = "";
                 this.mutPassword = "";
             }
         },

         mutEnabledCheckboxChanged: function(e) {
             console.log("mutEnabledCheckboxChanged()");
             if (e.target.checked) {
                 console.log("Mutual enabled.");
                 this.mutEnabled = true;
             } else {
                 console.log("Mutual disabled.");
                 this.mutEnabled = false;
             }
         },

         discInputCheckboxChanged: function(e) {
             console.log("discInputCheckboxChanged()");
             if (e.target.checked) {
                 console.log("Discovery input activated.");
                 this.discInputHidden = false;
                 this.$.addCommonAuthDialog.center();
                 /* Enabling mutual auth input auto-enables mutual auth. */
                 this.discEnabled = true;
             } else {
                 console.log("Discovery input de-activated.");
                 this.discInputHidden = true;
                 this.$.addCommonAuthDialog.center();
                 /* Disabling mutual auth input auto-disables mutual auth. */
                 this.discEnabled = false;
                 /* Clear bound vars. */
                 this.discUserId = "";
                 this.discPassword = "";
                 this.discMutUserId = "";
                 this.discMutPassword = "";
             }
         },

         discEnabledCheckboxChanged: function(e) {
             console.log("discEnabledCheckboxChanged()");
             if (e.target.checked) {
                 console.log("Discovery enabled.");
                 this.discEnabled = true;
             } else {
                 console.log("Discovery disabled.");
                 this.discEnabled = false;
             }
         },

         discMutInputCheckboxChanged: function(e) {
             console.log("discMutInputCheckboxChanged()");
             if (e.target.checked) {
                 console.log("Discovery mutual input activated.");
                 this.discMutInputHidden = false;
                 this.$.addCommonAuthDialog.center();
                 /* Enabling mutual auth input auto-enables mutual auth. */
                 this.discMutEnabled = true;
             } else {
                 console.log("Discovery mutual input de-activated.");
                 this.discMutInputHidden = true;
                 this.$.addCommonAuthDialog.center();
                 /* Disabling mutual auth input auto-disables mutual auth. */
                 this.discMutEnabled = false;
                 /* Clear bound vars. */
                 this.discMutUserId = "";
                 this.discMutPassword = "";
             }
         },

         discMutEnabledCheckboxChanged: function(e) {
             console.log("discMutEnabledCheckboxChanged()");
             if (e.target.checked) {
                 console.log("Discovery mutual enabled.");
                 this.discMutEnabled = true;
             } else {
                 console.log("Discovery mutual disabled.");
                 this.discMutEnabled = false;
             }
         },

         configureAuth: function(e) {
             var authType = e.model.__data__.a;
             console.log("configureAuth(): " + authType.desc + " selected.");
             /* console.log(e.currentTarget);*/

             /* TODO: If common auth dialog will be used, no need for type
              * detection beyond 'if !null'
              */
             if (authType.type === null) {
                 this.auth = null;
                 this.authHidden = true;
             } else if (authType.type === CommonAuth) {
                 this.$.addCommonAuthDialog.open();
             } else {
                 alert("Invalid authentication type selected.");
             }
         },

         addCommonAuth: function() {
             console.log("addCommonAuth:");
             console.log("Creating new auth with userid: " + this.userid + " password: "
                       + this.password + " initiatorList: " + this.initiatorList);

             /* By default, our initiator list will be empty. */
             var iList = [];

             /* If the user has entered a list of initiators, process them. */
             if (this.initiatorList.length) {
                 /* Remove blank entries from initiatorList, which is currently just a long string. */
                 iList = this.initiatorList.split("\n");
                 for (var i = 0; i < iList.length; i++) {
                     if (iList[i].length === 0) {
                         iList.splice(i, 1);
                     }
                 }
             }

             /* Check mutual auth. */
             /* TODO: better error detection needed. */
             var mutAuth = null;
             if (this.mutUserId.length && this.mutPassword.length) {
                 mutAuth = new MutualAuthFrag(this.mutUserId, this.mutPassword, this.mutEnabled);
             }

             /* Check discovery auth. */
             /* TODO: better error detection needed. */
             var discAuth = null;
             if (this.discUserId.length && this.discPassword.length) {
                 /* Check discovery mutual auth. */
                 var discMutAuth = null
                 if (this.discMutUserId.length && this.discMutPassword.length) {
                     discMutAuth = new MutualAuthFrag(this.discMutUserId, this.discMutPassword, this.discMutEnabled);
                 }
                 discAuth = new DiscoveryAuthFrag(this.discUserId, this.discPassword, this.discEnabled, discMutAuth);
             }

             this.auth = new CommonAuth(this.userid, this.password, iList, mutAuth, discAuth);
             console.log(this.auth);
             this.$.addCommonAuthDialog.close();
             this.authHidden = false;
         },

     });
    </script>
</dom-module>
