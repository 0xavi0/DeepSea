<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="salt-api" attributes="node port cmd target func userid password authtype">
    <template>
        <iron-ajax
            id="saltapi"
            url="http://{{node}}:{{port}}/{{cmd}}/"
            content-type="{{contentType}}"
            method="{{method}}"
            body='{"client":"local", "tgt":"{{target}}", "fun":"{{func}}", "username":"{{userid}}", "password":"{{password}}", "eauth":"{{authtype}}"}'
            handle-as="json"
            on-response="handle200"
            on-error="handleErr"
            with-credentials="true">
        </iron-ajax>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'salt-api',

        properties: {
            method: {
                type: String,
                value: ""
            },
            contentType: {
                type: String,
            }
        },

        _setContentType: function() {
            /* The only fully authenticated call we expect is for /login.
             *   If cmd===login, set content-type to allow POST preflight (ie. OPTIONS).
             *   If not, leave content-type blank to disable POST preflight and rely on cookie auth.
             */
            if (this.cmd === "login")
                this.contentType="application/json";
            else
                this.contentType="";
        },

        runGet: function() {
            this._setContentType();
            this.method = "GET";
            this.$.saltapi.generateRequest();
        },

        runPost: function() {
            this._setContentType();
            this.method = "POST";
            this.$.saltapi.generateRequest();
        },

        handle200: function(e) {
            console.log("salt-api:handle200(): firing 'salt-api-response' event.");
            this.fire("salt-api-response");
        },

        handleErr: function(e) {
            console.log("salt-api:handleErr(): firing 'salt-api-error' event");
            this.fire("salt-api-error");
        },
    });
</script>
