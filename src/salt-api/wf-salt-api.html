<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../salt-api/salt-api.html">

<dom-module id="wf-salt-api" attributes="cmd arg target func">
    <template>
        <salt-api
            id="wfsaltapi"
            node="{{saltApiNode}}"
            port="{{saltApiPort}}"
            cmd="{{cmd}}"
            arg="{{arg}}"
            target="{{target}}"
            func="{{func}}"
            userid=""
            password=""
            authtype=""
            on-response="handle200"
            on-error="handleErr">
        </salt-api>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'wf-salt-api',

        properties: {
            saltApiNode: {
                type: String
            },
            saltApiPort: {
                type: Number
            },
            method: {
                type: String,
                value: ""
            },
            contentType: {
                type: String,
            }
        },

        listeners: {
            "salt-api-response": "handle200",
            "salt-api-error": "handleErr"
        },

        /* Prepare the elemtn by retrieving sessionStorage.wfauth. */
        ready: function() {
            if (sessionStorage.wfauth && sessionStorage.wfauth !== "{}") {
                var wfauth = JSON.parse(sessionStorage.wfauth);
                this.saltApiNode = wfauth.node;
                this.saltApiPort = wfauth.port;
            } else {
                /* We have no state.  All we can do is re-prompt for auth credentials. */
                console.log(this.is + ":" + arguments.callee.name + ": sessionStorage.wfauth not found.  Firing 'wf-salt-api-error-401'");
                this._fire401ToWfAuth();
            }
        },

        _fire401ToWfAuth: function() {
            /* Try to fire an event to wf-auth. */
            var wfAuth = document.querySelector("wf-auth");
            if (wfAuth) {
                wfAuth.fire("wf-salt-api-error-401");
            } else {
                /* TODO: we have no wf-auth!!! */
            }
        },

        runGet: function() {
            this.$.wfsaltapi.runGet();
        },

        runPost: function() {
            this.$.wfsaltapi.runPost();
        },

        handle200: function(e, detail) {
            console.log(this.is + ":" + arguments.callee.name + ": caught " + e.type);
            console.log(this.is + ":" + arguments.callee.name + ": firing 'wf-salt-api-response' event");
            this.fire("wf-salt-api-response", e.detail);
        },

        handleErr: function(e, detail) {
            console.log(this.is + ":" + arguments.callee.name + ": caught " + e.type);
            /* If the returned status is 401 _or_ 0 (ie. the stal-api server is down
             * the user will need to re-authenticate to get a valid cookie in both cases.
             * Thus, it makes sense to treat both errors as a 401.
             */
            if (e.detail.request.status == 401 || e.detail.request.status == 0) {
                this._fire401ToWfAuth();
            }
            console.log(this.is + ":" + arguments.callee.name + ": firing 'wf-salt-api-error' event");
            this.fire("wf-salt-api-error", e.detail);
        },
    });
</script>
