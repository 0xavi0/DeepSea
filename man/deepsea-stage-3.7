.TH deepsea 7
.SH NAME
DeepSea stage 3 \- a deeper insight
.SH DESCRIPTION
.B DeepSea Stage 3 (Deploy)
is a Salt orchestration that deploys the core services of Ceph.
.RE
.PD
.SH PREFACE
.PP
This stage installs and starts the core services.  These are monitors, managers and storage (OSDs).  Upon completion, a Ceph cluster is running.

.B Validation
.RS
DeepSea validates several prerequisites.  The firewall and apparmor are disabled.  The Ceph fsid, public network, cluster network and master role are defined.  All storage nodes define an interface on the cluster network.  The monitors, managers and storage nodes are sufficient.  A Ganesha role requires either RadosGW or CephFS.  A time server is present.  Lastly, all minions match their fqdn. 

Some of these validations may be bypassed by setting
.B DEV_ENV
to true in the environment or the Salt pillar.  Specifically, the minimum required monitors, managers and storage nodes can have no redundancy which is only suitable for a development environment.
.RE

.B Time
.RS
Configure minions as clients to an existing time server.
.RE

.B Packages
.RS
Install ceph packages.
.RE

.B Ceph Configuration
.RS
Generate and distribute the ceph.conf.  Files in
.B /srv/salt/ceph/configuration/files/ceph.conf.d
will be included.  Please consult the README in this directory for more information.
.RE

.B Service Configuration Check
.RS
Determine which related services will be restarted.
.RE

.B Admin Role
.RS
Distribute the admin keyring.
.RE

.B Mon Role
.RS
Distribute keyring and start the service.
.RE

.B Mgr Role
.RS
Distribute keyring and start the service.
.RE

.B Prometheus exporters
.RS
Configure and start the RBD and Ceph exporter.
.RE

.B Sysctl
.RS
Configure system settings of minions.  Currently, fs.aio-max-nr is set to 1M.
.RE

.B Storage Role
.RS
Distribute bootstrap keyring and start the OSD(s).
.RE

.B Grains
.RS
Capture all devices related to each OSD in a Salt grain.  For more information, see 
.UR https://docs.saltstack.com/en/latest/topics/grains/.
.UE
.RE
.RE
.SS Process Restart
.RS
Updated services may require a restart.  If a process is using a
.B deleted file
or the
.B configuration has changed,
then the orchestration will restart that process.  Each process is restarted sequentially with the same health checks as Stage 0.  Stage 3 will abort if processes do not restart successfully.  Only Stage 3 related services (mon, mgr, osd) will be restarted.
.RE

.SH EXAMPLE
salt-run state.orch ceph.stage.3
.PP
This command can also be used with the
.B deepsea(1)
to give feedback during the process from the Salt event bus.  Salt orchestrations are unnervingly silent during execution 
and only report when complete.
.PP
deepsea salt-run state.orch ceph.stage.3
.PP
deepsea stage run ceph.stage.3

.SH AUTHOR
Joshua Schmid <jschmid@suse.com>
.SH SEE ALSO
.BR deepsea (1),
.BR deepsea (7),
.BR deepsea-commands (7),
.BR deepsea-stage-0 (7),
.BR deepsea-stage-1 (7),
.BR deepsea-stage-2 (7),
.BR deepsea-stage-4 (7),
.BR deepsea-stage-5 (7),
.BR deepsea-customization (7),
.BR deepsea-mines (7)
